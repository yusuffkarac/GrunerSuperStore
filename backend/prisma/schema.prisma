// ===================================
// GRUNER SUPERSTORE - PRISMA SCHEMA
// ===================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===================================
// ENUMS
// ===================================

enum OrderType {
  pickup
  delivery

  @@map("order_type")
}

enum OrderStatus {
  pending
  accepted
  preparing
  shipped
  delivered
  cancelled

  @@map("order_status")
}

enum PaymentType {
  none
  cash
  card_on_delivery

  @@map("payment_type")
}

enum CampaignType {
  PERCENTAGE // %20 indirim
  FIXED_AMOUNT // 10€ indirim
  BUY_X_GET_Y // 2 al 1 öde
  FREE_SHIPPING // Ücretsiz kargo

  @@map("campaign_type")
}

enum CouponType {
  PERCENTAGE // %20 indirim
  FIXED_AMOUNT // 10€ indirim

  @@map("coupon_type")
}

enum EmailStatus {
  pending
  sent
  failed

  @@map("email_status")
}

enum NotificationType {
  info
  success
  warning
  error

  @@map("notification_type")
}

// ===================================
// MODELS
// ===================================

model User {
  id                          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName                   String    @map("first_name")
  lastName                    String    @map("last_name")
  email                       String    @unique
  passwordHash                String    @map("password_hash")
  phone                       String?
  isActive                    Boolean   @default(true) @map("is_active")
  isEmailVerified             Boolean   @default(false) @map("is_email_verified")
  emailVerificationCode       String?   @map("email_verification_code")
  emailVerificationCodeExpiry DateTime? @map("email_verification_code_expiry")
  newEmail                    String?   @map("new_email")
  emailChangeCode             String?   @map("email_change_code")
  emailChangeCodeExpiry       DateTime? @map("email_change_code_expiry")
  createdAt                   DateTime  @default(now()) @map("created_at")
  updatedAt                   DateTime  @updatedAt @map("updated_at")

  // Relations
  addresses    Address[]
  cartItems    CartItem[]
  orders       Order[]
  favorites    Favorite[]
  couponUsages CouponUsage[]
  notifications Notification[]
  orderReviews OrderReview[]

  @@index([email])
  @@index([isActive])
  @@index([isEmailVerified])
  @@index([createdAt(sort: Desc)])
  @@map("users")
}

model Address {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String   @map("user_id") @db.Uuid
  title        String
  street       String
  houseNumber  String   @map("house_number")
  addressLine2 String?  @map("address_line2")
  district     String?
  postalCode   String   @map("postal_code")
  city         String
  state        String?
  description  String?
  latitude     Decimal? @db.Decimal(10, 8)
  longitude    Decimal? @db.Decimal(11, 8)
  isDefault    Boolean  @default(false) @map("is_default")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  user            User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  deliveryOrders Order[] @relation("OrderDeliveryAddress")
  billingOrders  Order[] @relation("OrderBillingAddress")

  @@index([userId])
  @@index([postalCode])
  @@index([city])
  @@index([state])
  @@index([userId, isDefault])
  @@map("addresses")
}

model Category {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String
  slug      String   @unique
  imageUrl  String?  @map("image_url")
  sortOrder Int?     @map("sort_order")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  products Product[]

  @@index([slug])
  @@index([isActive])
  @@index([sortOrder])
  @@map("categories")
}

model Product {
  id                      String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId              String    @map("category_id") @db.Uuid
  name                    String
  slug                    String    @unique
  description             String?
  price                   Decimal   @db.Decimal(12, 2)
  temporaryPrice          Decimal?  @map("temporary_price") @db.Decimal(12, 2)
  temporaryPriceEndDate   DateTime? @map("temporary_price_end_date")
  taxRate                 Decimal?  @map("tax_rate") @db.Decimal(5, 2) // Vergi oranı (örn: 19.00 = %19)
  stock                   Int       @default(0)
  lowStockLevel           Int?      @map("low_stock_level")
  unit                    String?
  barcode                 String?
  brand                   String?
  imageUrls               Json      @default("[]") @map("image_urls")
  ingredientsText         String?   @map("ingredients_text")
  allergens               Json?     @default("[]")
  nutriscoreGrade         String?   @map("nutriscore_grade")
  ecoscoreGrade           String?   @map("ecoscore_grade")
  nutritionData           Json?     @map("nutrition_data")
  openfoodfactsCategories Json?     @map("openfoodfacts_categories")
  isActive                Boolean   @default(true) @map("is_active")
  isFeatured              Boolean   @default(false) @map("is_featured")
  showStock               Boolean   @default(false) @map("show_stock")
  supplier                String?   // Tedarikçi bilgisi
  // Son Kullanma Tarihi (SKT) yönetimi
  expiryDate              DateTime? @map("expiry_date") // Son kullanma tarihi
  excludeFromExpiryCheck  Boolean   @default(false) @map("exclude_from_expiry_check") // SKT kontrolünden muaf
  createdAt               DateTime  @default(now()) @map("created_at")
  updatedAt               DateTime  @updatedAt @map("updated_at")

  // Relations
  category       Category               @relation(fields: [categoryId], references: [id], onDelete: Restrict)
  cartItems      CartItem[]
  orderItems     OrderItem[]
  favorites      Favorite[]
  variantOptions ProductVariantOption[]
  variants       ProductVariant[]
  expiryActions  ExpiryAction[]
  taskIgnores    ProductTaskIgnore[]
  stockOrders    StockOrder[]

  @@index([slug])
  @@index([name])
  @@index([brand])
  @@index([categoryId])
  @@index([isActive])
  @@index([isFeatured])
  @@index([price])
  @@index([stock])
  @@index([barcode])
  @@index([expiryDate])
  @@index([excludeFromExpiryCheck, expiryDate])
  @@index([isFeatured, isActive])
  @@map("products")
}

model CartItem {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  variantId String?  @map("variant_id") @db.Uuid
  quantity  Int
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([productId])
  @@index([variantId])
  @@index([userId, productId, variantId])
  @@map("cart_items")
}

model Order {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String      @map("user_id") @db.Uuid
  orderNo     String      @unique @map("order_no")
  type        OrderType
  status      OrderStatus @default(pending)
  addressId   String?     @map("address_id") @db.Uuid
  billingAddressId String? @map("billing_address_id") @db.Uuid // Fatura adresi
  deliveryFee Decimal     @default(0) @map("delivery_fee") @db.Decimal(12, 2)
  subtotal    Decimal     @map("subtotal") @db.Decimal(12, 2)
  discount    Decimal     @default(0) @db.Decimal(12, 2) // Kupon indirimi
  total       Decimal     @db.Decimal(12, 2)
  paymentType PaymentType @default(none) @map("payment_type")
  couponId    String?     @map("coupon_id") @db.Uuid
  couponCode  String?     @map("coupon_code") // Snapshot
  note        String?
  // İptal bilgileri (Admin tarafından doldurulur)
  cancellationReason              String?  @map("cancellation_reason") // İptal sebebi (müşteriye gösterilebilir)
  cancellationInternalNote        String?  @map("cancellation_internal_note") // Internal not (müşteriye gösterilmez)
  cancellationCustomerMessage     String?  @map("cancellation_customer_message") // Müşteriye özel mesaj
  showCancellationReasonToCustomer Boolean @default(false) @map("show_cancellation_reason_to_customer") // İptal sebebini müşteriye göster
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  // Relations
  user           User         @relation(fields: [userId], references: [id], onDelete: Restrict)
  address        Address?     @relation("OrderDeliveryAddress", fields: [addressId], references: [id], onDelete: Restrict)
  billingAddress Address?     @relation("OrderBillingAddress", fields: [billingAddressId], references: [id], onDelete: Restrict)
  coupon         Coupon?      @relation(fields: [couponId], references: [id], onDelete: SetNull)
  orderItems     OrderItem[]
  review         OrderReview?

  @@index([orderNo])
  @@index([userId, createdAt(sort: Desc)])
  @@index([status])
  @@index([type])
  @@index([createdAt(sort: Desc)])
  @@index([addressId])
  @@index([billingAddressId])
  @@index([couponId])
  @@index([userId, status, createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId       String   @map("order_id") @db.Uuid
  productId     String   @map("product_id") @db.Uuid
  variantId     String?  @map("variant_id") @db.Uuid
  productName   String   @map("product_name")
  variantName   String?  @map("variant_name")
  price         Decimal  @db.Decimal(12, 2) // İndirimli fiyat
  originalPrice Decimal? @map("original_price") @db.Decimal(12, 2) // Orijinal fiyat (kampanya varsa)
  campaignId    String?  @map("campaign_id") @db.Uuid // Uygulanan kampanya
  campaignName  String?  @map("campaign_name") // Kampanya adı (snapshot)
  quantity      Int
  unit          String?
  brand         String?
  imageUrl      String?  @map("image_url")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  order   Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product         @relation(fields: [productId], references: [id], onDelete: Restrict)
  variant ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  @@index([orderId])
  @@index([productId])
  @@index([variantId])
  @@index([campaignId])
  @@map("order_items")
}

model OrderReview {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId   String   @unique @map("order_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  rating    Int // 1-5 arası yıldız
  comment   String?
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([userId])
  @@index([rating])
  @@index([createdAt(sort: Desc)])
  @@map("order_reviews")
}

model Favorite {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  productId String   @map("product_id") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
  @@index([userId])
  @@index([productId])
  @@index([createdAt(sort: Desc)])
  @@map("favorites")
}

model Coupon {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code            String     @unique // Kupon kodu
  name            String? // Kupon adı/açıklaması
  type            CouponType // PERCENTAGE veya FIXED_AMOUNT
  discountPercent Decimal?   @map("discount_percent") @db.Decimal(5, 2) // %50.00 gibi
  discountAmount  Decimal?   @map("discount_amount") @db.Decimal(12, 2) // 10.00€ gibi

  // Tarih aralığı
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  // Uygulama kuralları
  minPurchase    Decimal? @map("min_purchase") @db.Decimal(12, 2) // Min sepet tutarı
  maxDiscount    Decimal? @map("max_discount") @db.Decimal(12, 2) // Max indirim tutarı
  usageLimit     Int?     @map("usage_limit") // Toplam kullanım limiti
  usageCount     Int      @default(0) @map("usage_count") // Kullanım sayısı
  userUsageLimit Int?     @default(1) @map("user_usage_limit") // Kullanıcı başına kullanım limiti

  // Hedefleme
  applyToAll  Boolean @default(true) @map("apply_to_all") // Tüm mağaza
  userIds     Json?   @map("user_ids") // ["uuid1", "uuid2"] - Kişiye özel
  categoryIds Json?   @map("category_ids") // ["uuid1", "uuid2"]
  productIds  Json?   @map("product_ids") // ["uuid1", "uuid2"]

  // Durumlar
  isActive Boolean @default(true) @map("is_active")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  orders Order[]
  usages CouponUsage[]

  @@index([code])
  @@index([isActive])
  @@index([type])
  @@index([startDate, endDate])
  @@index([isActive, startDate, endDate])
  @@map("coupons")
}

model CouponUsage {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  couponId  String   @map("coupon_id") @db.Uuid
  userId    String   @map("user_id") @db.Uuid
  orderId   String?  @map("order_id") @db.Uuid
  discount  Decimal  @db.Decimal(12, 2) // Uygulanan indirim tutarı
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
  @@index([couponId, userId])
  @@index([createdAt(sort: Desc)])
  @@map("coupon_usages")
}

model DeliveryZone {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  minimumAmount Decimal? @map("minimum_amount") @db.Decimal(12, 2)
  deliveryFee   Decimal  @map("delivery_fee") @db.Decimal(12, 2)
  estimatedTime Int      @map("estimated_time")
  maxDistanceKm Decimal? @map("max_distance_km") @db.Decimal(6, 2)
  isActive      Boolean  @default(true) @map("is_active")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@index([isActive])
  @@index([minimumAmount])
  @@index([maxDistanceKm])
  @@map("delivery_zones")
}

model Admin {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  firstName    String   @map("first_name")
  email        String   @unique
  passwordHash String   @map("password_hash")
  role         String   @default("admin") // Eski sistem ile uyumluluk için
  roleId       String?  @map("role_id") @db.Uuid // Yeni rol sistemi
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  adminRole     AdminRole?     @relation(fields: [roleId], references: [id], onDelete: SetNull)
  expiryActions ExpiryAction[]
  stockOrders   StockOrder[]   @relation("StockOrderAdmin")
  stockOrdersUndone StockOrder[] @relation("StockOrderUndoneBy")
  stockOrderLists StockOrderList[] @relation("StockOrderListAdmin")
  supplierEmails SupplierEmail[] @relation("SupplierEmailAdmin")

  @@index([email])
  @@index([role])
  @@index([roleId])
  @@map("admins")
}

model AdminRole {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique // Örn: "Süper Admin", "Depo Sorumlusu", "Kasa"
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  admins      Admin[]
  permissions RolePermission[]

  @@index([name])
  @@index([isActive])
  @@map("admin_roles")
}

model AdminPermission {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String   @unique // Örn: "product_management", "expiry_management"
  displayName String   @map("display_name") // Örn: "Ürün Yönetimi", "SKT Yönetimi"
  description String?
  category    String? // Örn: "products", "expiry", "orders"
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Relations
  roles RolePermission[]

  @@index([name])
  @@index([category])
  @@map("admin_permissions")
}

model RolePermission {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  roleId       String   @map("role_id") @db.Uuid
  permissionId String   @map("permission_id") @db.Uuid
  createdAt    DateTime @default(now()) @map("created_at")

  // Relations
  role       AdminRole       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission AdminPermission @relation(fields: [permissionId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
  @@index([roleId])
  @@index([permissionId])
  @@map("role_permissions")
}

model Settings {
  id                        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  guestCanViewProducts      Boolean  @default(true) @map("guest_can_view_products")
  showOutOfStockProducts    Boolean  @default(true) @map("show_out_of_stock_products")
  homepageSettings          Json?    @map("homepage_settings")
  orderIdFormat             Json?    @map("order_id_format")
  themeColors               Json?    @map("theme_colors")
  // Business ayarları
  minOrderAmount            Decimal? @map("min_order_amount") @db.Decimal(12, 2)
  freeShippingThreshold     Decimal? @map("free_shipping_threshold") @db.Decimal(12, 2)
  shippingRules             Json?    @map("shipping_rules")
  deliverySettings          Json?    @map("delivery_settings")
  paymentOptions            Json?    @map("payment_options")
  orderLimits               Json?    @map("order_limits")
  storeSettings             Json?    @map("store_settings")
  // Mail ayarları
  smtpSettings              Json?    @map("smtp_settings")
  emailNotificationSettings Json?    @map("email_notification_settings")
  emailTemplates            Json?    @map("email_templates")
  notificationTemplates      Json?    @map("notification_templates")
  // Barkod etiket ayarları
  barcodeLabelSettings      Json?    @map("barcode_label_settings")
  // Kunden Stornierung Einstellungen
  customerCancellationSettings Json? @map("customer_cancellation_settings")
  // SKT yönetim ayarları
  expiryManagementSettings  Json?    @map("expiry_management_settings")
  // Örnek: { "enabled": true, "warningDays": 3, "criticalDays": 0 }
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")

  @@map("settings")
}

model Campaign {
  id          String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String
  slug        String  @unique
  description String?
  imageUrl    String? @map("image_url")

  // Kampanya tipi
  type CampaignType

  // İndirim değerleri
  discountPercent Decimal? @map("discount_percent") @db.Decimal(5, 2) // %50.00 gibi
  discountAmount  Decimal? @map("discount_amount") @db.Decimal(12, 2) // 10.00€ gibi

  // X Al Y Öde için
  buyQuantity Int? @map("buy_quantity") // Örn: 3 (3 al)
  getQuantity Int? @map("get_quantity") // Örn: 2 (2 öde)

  // Tarih aralığı
  startDate DateTime @map("start_date")
  endDate   DateTime @map("end_date")

  // Uygulama kuralları
  minPurchase Decimal? @map("min_purchase") @db.Decimal(12, 2) // Min sepet tutarı
  maxDiscount Decimal? @map("max_discount") @db.Decimal(12, 2) // Max indirim tutarı
  usageLimit  Int?     @map("usage_limit") // Toplam kullanım limiti
  usageCount  Int      @default(0) @map("usage_count") // Kullanım sayısı

  // Hedefleme
  applyToAll  Boolean @default(false) @map("apply_to_all") // Tüm mağaza
  categoryIds Json?   @map("category_ids") // ["uuid1", "uuid2"]
  productIds  Json?   @map("product_ids") // ["uuid1", "uuid2"]

  // Durumlar
  isActive Boolean @default(true) @map("is_active")
  priority Int     @default(0) // Yüksek öncelik önce uygulanır

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([slug])
  @@index([isActive])
  @@index([type])
  @@index([startDate, endDate])
  @@index([isActive, priority])
  @@index([applyToAll, isActive])
  @@map("campaigns")
}

// ===================================
// BARCODE LABELS
// ===================================

model BarcodeLabel {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String // Product name
  price     Decimal  @db.Decimal(12, 2)
  unit      String? // Optional unit type (kg, adet, litre, etc.)
  barcode   String // Barcode number
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@index([barcode])
  @@index([name])
  @@index([createdAt(sort: Desc)])
  @@map("barcode_labels")
}

// ===================================
// PRODUCT VARIANTS
// ===================================

model ProductVariantOption {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId    String   @map("product_id") @db.Uuid
  name         String // Örn: "Renk", "Beden", "Boyut"
  displayOrder Int      @default(0) @map("display_order")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  // Relations
  product Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  values  ProductVariantValue[]

  @@index([productId])
  @@index([productId, displayOrder])
  @@map("product_variant_options")
}

model ProductVariant {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String   @map("product_id") @db.Uuid
  name      String // Örn: "Kırmızı - S", "Mavi - M"
  price     Decimal  @db.Decimal(12, 2)
  stock     Int      @default(0)
  sku       String?  @unique
  imageUrls Json     @default("[]") @map("image_urls")
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  product    Product               @relation(fields: [productId], references: [id], onDelete: Cascade)
  values     ProductVariantValue[]
  cartItems  CartItem[]
  orderItems OrderItem[]

  @@index([productId])
  @@index([productId, isActive])
  @@index([sku])
  @@index([stock])
  @@map("product_variants")
}

model ProductVariantValue {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  variantId String   @map("variant_id") @db.Uuid
  optionId  String   @map("option_id") @db.Uuid
  value     String // Örn: "Kırmızı", "S", "M"
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  variant ProductVariant       @relation(fields: [variantId], references: [id], onDelete: Cascade)
  option  ProductVariantOption @relation(fields: [optionId], references: [id], onDelete: Cascade)

  @@unique([variantId, optionId])
  @@index([variantId])
  @@index([optionId])
  @@map("product_variant_values")
}

// ===================================
// EMAIL SYSTEM
// ===================================

model EmailLog {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  to        String
  subject   String
  template  String // welcome, order-received, vb.
  status    EmailStatus @default(pending)
  error     String?
  sentAt    DateTime?   @map("sent_at")
  metadata  Json? // orderId, userId vb.
  createdAt DateTime    @default(now()) @map("created_at")
  updatedAt DateTime    @updatedAt @map("updated_at")

  @@index([to])
  @@index([status])
  @@index([template])
  @@index([createdAt(sort: Desc)])
  @@map("email_logs")
}

// ===================================
// NOTIFICATION SYSTEM
// ===================================

model Notification {
  id        String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String          @map("user_id") @db.Uuid
  type      NotificationType @default(info)
  title     String
  message   String
  actionUrl String?         @map("action_url")
  isRead    Boolean         @default(false) @map("is_read")
  readAt    DateTime?       @map("read_at")
  metadata  Json?           // orderId, campaignId vb. ek bilgiler
  createdAt DateTime        @default(now()) @map("created_at")
  updatedAt DateTime        @updatedAt @map("updated_at")

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([isRead])
  @@index([createdAt(sort: Desc)])
  @@index([userId, isRead])
  @@index([userId, createdAt(sort: Desc)])
  @@map("notifications")
}

// ===================================
// EXPIRY DATE MANAGEMENT (SKT)
// ===================================

enum ExpiryActionType {
  labeled // Etiketlendi (indirim etiketi yapıştırıldı)
  removed // Raftan kaldırıldı
  undone // İşlem geri alındı

  @@map("expiry_action_type")
}

model ExpiryAction {
  id             String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId      String           @map("product_id") @db.Uuid
  adminId        String           @map("admin_id") @db.Uuid
  actionType     ExpiryActionType @map("action_type")
  expiryDate     DateTime         @map("expiry_date") // İşlem sırasındaki SKT
  daysUntilExpiry Int             @map("days_until_expiry") // İşlem sırasında kalan gün sayısı
  // Kaldırma işlemi için
  excludedFromCheck Boolean?      @default(false) @map("excluded_from_check") // Deaktif edildi mi?
  // Geri alma için
  previousActionId String?        @map("previous_action_id") @db.Uuid
  isUndone        Boolean         @default(false) @map("is_undone") // Bu işlem geri alındı mı?
  undoneAt        DateTime?       @map("undone_at")
  undoneBy        String?         @map("undone_by") @db.Uuid
  // Ek bilgiler
  note            String?
  createdAt       DateTime        @default(now()) @map("created_at")
  updatedAt       DateTime        @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  admin   Admin   @relation(fields: [adminId], references: [id], onDelete: Restrict)

  @@index([productId])
  @@index([adminId])
  @@index([actionType])
  @@index([isUndone])
  @@index([createdAt(sort: Desc)])
  @@index([productId, createdAt(sort: Desc)])
  @@index([adminId, createdAt(sort: Desc)])
  @@map("expiry_actions")
}

// ===================================
// STOCK ORDER MANAGEMENT
// ===================================

enum StockOrderStatus {
  pending    // Beklemede
  ordered    // Sipariş edildi
  delivered  // Teslim edildi
  cancelled  // İptal edildi

  @@map("stock_order_status")
}

model StockOrder {
  id                  String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId           String          @map("product_id") @db.Uuid
  adminId             String          @map("admin_id") @db.Uuid
  orderListId         String?         @map("order_list_id") @db.Uuid
  status              StockOrderStatus @default(pending)
  orderQuantity       Int             @map("order_quantity")
  orderUnit           String?         @map("order_unit") // karton/adet/kilo/palet
  expectedDeliveryDate DateTime?      @map("expected_delivery_date") @db.Date
  actualDeliveryDate  DateTime?      @map("actual_delivery_date") @db.Date
  note                String?
  previousOrderId     String?         @map("previous_order_id") @db.Uuid
  isUndone            Boolean         @default(false) @map("is_undone")
  undoneAt            DateTime?      @map("undone_at")
  undoneBy            String?         @map("undone_by") @db.Uuid
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")

  // Relations
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  admin         Admin   @relation("StockOrderAdmin", fields: [adminId], references: [id], onDelete: Restrict)
  orderList     StockOrderList? @relation(fields: [orderListId], references: [id], onDelete: SetNull)
  previousOrder StockOrder? @relation("PreviousStockOrder", fields: [previousOrderId], references: [id], onDelete: SetNull)
  reversedOrders StockOrder[] @relation("PreviousStockOrder")
  undoneByAdmin Admin? @relation("StockOrderUndoneBy", fields: [undoneBy], references: [id], onDelete: SetNull)

  @@index([productId])
  @@index([adminId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([isUndone])
  @@index([productId, status])
  @@index([productId, isUndone])
  @@index([orderListId])
  @@map("stock_orders")
}

model StockOrderList {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name          String
  note          String?
  supplierEmail String?         @map("supplier_email")
  sendToAdmins  Boolean         @default(false) @map("send_to_admins")
  sendToSupplier Boolean        @default(false) @map("send_to_supplier")
  adminId       String          @map("admin_id") @db.Uuid
  status        StockOrderStatus @default(pending)
  createdAt     DateTime        @default(now()) @map("created_at")
  updatedAt     DateTime        @updatedAt @map("updated_at")

  // Relations
  admin  Admin        @relation("StockOrderListAdmin", fields: [adminId], references: [id], onDelete: Restrict)
  orders StockOrder[]

  @@index([adminId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@index([status, createdAt(sort: Desc)])
  @@map("stock_order_lists")
}

model SupplierEmail {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email     String   @unique
  createdBy String   @map("created_by") @db.Uuid
  createdAt DateTime @default(now()) @map("created_at")

  // Relations
  admin Admin @relation("SupplierEmailAdmin", fields: [createdBy], references: [id], onDelete: Restrict)

  @@index([email])
  @@index([createdBy])
  @@index([createdAt(sort: Desc)])
  @@map("supplier_emails")
}

// ===================================
// BULK PRICE UPDATES
// ===================================

enum BulkPriceUpdateType {
  PERMANENT
  TEMPORARY
  @@map("bulk_price_update_type")
}

model BulkPriceUpdate {
  id                    String              @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  type                  String              // 'all' | 'category' | 'products'
  categoryId            String?             @map("category_id") @db.Uuid
  productIds            Json?               @map("product_ids") // ["uuid1", "uuid2"]
  adjustmentType        String              @map("adjustment_type") // 'percentage' | 'fixed'
  adjustmentValue       Decimal             @map("adjustment_value") @db.Decimal(12, 2)
  updateType            BulkPriceUpdateType @map("update_type") // PERMANENT | TEMPORARY
  temporaryPriceEndDate DateTime?           @map("temporary_price_end_date")
  includeVariants       Boolean             @default(false) @map("include_variants")
  affectedProducts      Json                @map("affected_products") // [{ productId, oldPrice, newPrice, variantId?, oldVariantPrice?, newVariantPrice? }]
  productsUpdated       Int                 @default(0) @map("products_updated")
  variantsUpdated       Int                 @default(0) @map("variants_updated")
  totalUpdated          Int                 @default(0) @map("total_updated")
  isReverted            Boolean             @default(false) @map("is_reverted")
  revertedAt            DateTime?           @map("reverted_at")
  revertedBy            String?             @map("reverted_by") @db.Uuid
  createdAt             DateTime            @default(now()) @map("created_at")
  updatedAt             DateTime            @updatedAt @map("updated_at")

  @@index([createdAt(sort: Desc)])
  @@index([isReverted])
  @@index([updateType])
  @@index([categoryId])
  @@map("bulk_price_updates")
}

// ===================================
// PRODUCT TASK IGNORES
// ===================================

model ProductTaskIgnore {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String   @map("product_id") @db.Uuid
  category  String   // 'image', 'barcode', 'category', 'price', 'expiryDate'
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  // Relations
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([category])
  @@index([productId, category])
  @@unique([productId, category])
  @@map("product_task_ignores")
}
